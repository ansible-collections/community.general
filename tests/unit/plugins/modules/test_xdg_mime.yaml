# -*- coding: utf-8 -*-
# Copyright (c) 2025, Marcos Alano <marcoshalano@gmail.com>
# Based on gio_mime module. Copyright (c) 2022, Alexei Znamensky <russoz@gmail.com>
# GNU General Public License v3.0+ (see LICENSES/GPL-3.0-or-later.txt or https://www.gnu.org/licenses/gpl-3.0.txt)
# SPDX-License-Identifier: GPL-3.0-or-later

---
anchors:
  environ: &env-def {environ_update: {LANGUAGE: C, LC_ALL: C}, check_rc: true}
test_cases:
  - id: test_set_handler
    input:
      handler: google-chrome.desktop
      mime_type: x-scheme-handler/http
    output:
      before_handlers: []
      after_handlers:
        - google-chrome.desktop
      changed: true
    mocks:
      run_command:
        - command: [/testbin/xdg-mime, --version]
          environ: *env-def
          rc: 0
          out: "1.2.1\n"
          err: ''
        - command: [/testbin/xdg-mime, query, default, x-scheme-handler/http]
          environ: *env-def
          rc: 0
          out: ''
          err: ''
        - command: [/testbin/xdg-mime, default, google-chrome.desktop, x-scheme-handler/http]
          environ: *env-def
          rc: 0
          out: ''
          err: ''
  - id: test_set_handler_check
    input:
      handler: google-chrome.desktop
      mime_type: x-scheme-handler/http
    output:
      before_handlers: []
      after_handlers:
        - google-chrome.desktop
      changed: true
      stdout: Module executed in check mode
      diff:
        before:
          before_handlers: null
        after:
          after_handlers:
            - google-chrome.desktop
    flags:
      check: true
      diff: true
    mocks:
      run_command:
        - command: [/testbin/xdg-mime, --version]
          environ: *env-def
          rc: 0
          out: "1.2.1\n"
          err: ''
        - command: [/testbin/xdg-mime, query, default, x-scheme-handler/http]
          environ: *env-def
          rc: 0
          out: ''
          err: ''
  - id: test_set_handler_idempot
    input:
      handler: google-chrome.desktop
      mime_type: x-scheme-handler/http
    output:
      before_handlers:
        - google-chrome.desktop
      after_handlers:
        - google-chrome.desktop
      changed: false
    mocks:
      run_command:
        - command: [/testbin/xdg-mime, --version]
          environ: *env-def
          rc: 0
          out: "1.2.1\n"
          err: ''
        - command: [/testbin/xdg-mime, query, default, x-scheme-handler/http]
          environ: *env-def
          rc: 0
          out: |
            google-chrome.desktop
          err: ''
  - id: test_set_handler_idempot_check
    input:
      handler: google-chrome.desktop
      mime_type: x-scheme-handler/http
    output:
      before_handlers:
        - google-chrome.desktop
      after_handlers:
        - google-chrome.desktop
      changed: false
    flags:
      check: true
    mocks:
      run_command:
        - command: [/testbin/xdg-mime, --version]
          environ: *env-def
          rc: 0
          out: "1.2.1\n"
          err: ''
        - command: [/testbin/xdg-mime, query, default, x-scheme-handler/http]
          environ: *env-def
          rc: 0
          out: |
            google-chrome.desktop
          err: ''
  - id: test_set_invalid_handler
    input:
      handler: google-chrome.desktopX
      mime_type: x-scheme-handler/http
    output:
      failed: true
      msg: 'Handler must be a .desktop file'
    mocks:
      run_command:
        - command: [/testbin/xdg-mime, --version]
          environ: *env-def
          rc: 0
          out: "1.2.1\n"
          err: ''
        - command: [/testbin/xdg-mime, query, default, x-scheme-handler/http]
          environ: *env-def
          rc: 0
          out: ''
          err: ''
        - command: [/testbin/xdg-mime, default, google-chrome.desktopX, x-scheme-handler/http]
          environ: *env-def
          rc: 1
          out: ''
          err: |
            xdg-mime: malformed argument 'google-chrome.desktopX', expected *.desktop
            Try 'xdg-mime --help' for more information.
