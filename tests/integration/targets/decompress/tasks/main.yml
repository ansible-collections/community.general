---
# Copyright (c) Ansible Project
# GNU General Public License v3.0+ (see LICENSES/GPL-3.0-or-later.txt or https://www.gnu.org/licenses/gpl-3.0.txt)
# SPDX-License-Identifier: GPL-3.0-or-later

- name: Copy test files
  copy:
    src: "files/"
    dest: "{{ remote_tmp_dir }}"

- name: Get original file stat
  stat:
    path: "{{ remote_tmp_dir }}/file.txt"
  register: orig_file_stat

- name: Set supported formats
  set_fact:
    formats:
      - bz2
      - gz
      - xz

- name: Ensure xz is present to create compressed files (yum)
  yum: name=xz state=latest
  when: ansible_facts.pkg_mgr == 'yum'

- name: Ensure xz is present to create compressed files (apt)
  apt: name=xz-utils state=latest
  when: ansible_facts.pkg_mgr == 'apt'

- name: Generate compressed files
  shell: gzip -k {{ item }} && bzip2 -k {{ item }} && xz -k {{ item }}
  loop:
    - "{{ remote_tmp_dir }}/file.txt"
    - "{{ remote_tmp_dir }}/second_file.txt"

# Run tests
- name: Run core tests
  block:
    - include_tasks: core.yml
      loop: "{{ formats }}"
      loop_control:
        loop_var: format
    - import_tasks: cleanup.yml


- name: Run idempotency and check mode tests
  block:
    - import_tasks: misc.yml
    - import_tasks: cleanup.yml

- name: Run tests for destination file
  block:
    - import_tasks: dest.yml
    - import_tasks: cleanup.yml