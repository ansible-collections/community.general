- name: Include distribution specific variables
  include_vars: "{{ lookup('first_found', params) }}"
  vars:
    params:
      files:
        - "{{ ansible_facts.distribution }}.yml"
        - "{{ ansible_facts.os_family }}.yml"
        - default.yml
      paths:
        - "{{ role_path }}/vars"

- name: Install package
  action: "{{ ansible_facts.pkg_mgr }}"
  args:
    name: "{{ passwordstore_packages }}"
    state: present
  when: ansible_facts.pkg_mgr in ['apt', 'dnf', 'yum', 'pkgng', 'community.general.pkgng']

- block:
  # OpenSUSE Leap>=15.0 don't include password-store in main repo
  - name: SUSE | Add security:privacy repo
    template:
      src: security-privacy.repo.j2
      dest: /etc/zypp/repos.d/security:privacy.repo

  - name: SUSE | Install package
    package:
      name: password-store
      state: present
      update_cache: yes
      disable_gpg_check: yes
  when: ansible_facts.pkg_mgr in ['zypper', 'community.general.zypper']

# See https://github.com/gopasspw/gopass/issues/1849#issuecomment-802789285
- name: Install on Debian
  when: ansible_facts.os_family == 'Debian'
  become: yes
  block:
  - name: Fetch gopass repo keyring
    shell: curl -o /usr/share/keyrings/gopass-archive-keyring.gpg \
      https://packages.gopass.pw/repos/gopass/gopass-archive-keyring.gpg
  - name: Add gopass repo
    command: tee /etc/apt/sources.list.d/gopass.sources
    args:
      stdin: |
        Types: deb
        URIs: https://packages.gopass.pw/repos/gopass
        Suites: stable
        Architectures: amd64 arm64 armhf
        Components: main
        Signed-By: /usr/share/keyrings/gopass-archive-keyring.gpg
  - name: Update repo
    command: apt update
  - name: Install package from gopass repo
    command: apt install -y gopass

- name: Install on macOS
  when: ansible_facts.distribution == 'MacOSX'
  block:
    - name: MACOS | Find brew binary
      command: which brew
      register: brew_which

    - name: MACOS | Get owner of brew binary
      stat:
        path: "{{ brew_which.stdout }}"
      register: brew_stat

    - name: MACOS | Install package
      homebrew:
        name:
          - gnupg2
          - pass
          - gopass
        state: present
        update_homebrew: no
      become: yes
      become_user: "{{ brew_stat.stat.pw_name }}"
      # Newer versions of brew want to compile a package which takes a long time. Do not upgrade homebrew until a
      # proper solution can be found
      environment:
        HOMEBREW_NO_AUTO_UPDATE: True
