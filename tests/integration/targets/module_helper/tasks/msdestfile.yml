---
# (c) 2022, DEMAREST Maxime <maxime@indelog.fr>
# GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)

- name: "<mdestfile> set dest_dir and dest_file for dest file module helper"
  set_fact:
    dest_dir: "{{ remote_tmp_dir }}/destdir/"
    dest_file: "{{ remote_tmp_dir }}/destdir/destfile.txt"

- name: "<mdestfile> ensure that remote_tmp_dir is readable by non privilegied user when run by root"
  ansible.builtin.file:
    path: "{{ remote_tmp_dir }}"
    mode: "0755"

- name: "<mdestfile> get info for distribution for debuging"
  ansible.builtin.debug:
    msg: "ansible_distribution : {{ ansible_distribution }} ansible_distribution_version : {{ ansible_distribution_version }} ansible_distribution_release : {{ ansible_distribution_release }}"

- name: "<mdestfile> run test cases for dest file module helper"
  include_tasks: msdestfile-run.yml
  loop: "{{ test_cases_dest_file_module_helper }}"
  loop_control:
    loop_var: case
  # Some cases requires to using `su` to become non-privileged user (that is
  # needed to test some behaviours when destination file has unexpected rights)
  # but, some platform does not provide suitable version of `su` and the test
  # case can not be run on those.
  when: not(ansible_user_uid == 0 and case.need_to_become_with_su and ansible_distribution in('RedHat', 'Darwin', 'FreeBSD'))
