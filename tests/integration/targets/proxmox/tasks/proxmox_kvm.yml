####################################################################
# WARNING: These are designed specifically for Ansible tests       #
# and should not be used as examples of how to write Ansible roles #
####################################################################

# Copyright: (c) 2020, Tristan Le Guern <tleguern at bouledef.eu>
# GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)

- name: VM start
  tags: [ 'start' ]
  block:
    - name: Start test VM
      proxmox_kvm:
        api_host: "{{ api_host }}"
        api_user: "{{ user }}@{{ domain }}"
        api_password: "{{ api_password | default(omit) }}"
        api_token_id: "{{ api_token_id | default(omit) }}"
        api_token_secret: "{{ api_token_secret | default(omit) }}"
        validate_certs: "{{ validate_certs }}"
        node: "{{ node }}"
        vmid: "{{ vmid }}"
        state: started
      register: results_action_start

    - assert:
        that:
        - results_action_start is changed
        - results_action_start.status == 'stopped'
        - results_action_start.vmid == {{ vmid }}
        - results_action_start.msg == "VM {{ vmid }} started"

    - pause:
        seconds: 90

    - name: Try to start test VM again
      proxmox_kvm:
        api_host: "{{ api_host }}"
        api_user: "{{ user }}@{{ domain }}"
        api_password: "{{ api_password | default(omit) }}"
        api_token_id: "{{ api_token_id | default(omit) }}"
        api_token_secret: "{{ api_token_secret | default(omit) }}"
        validate_certs: "{{ validate_certs }}"
        node: "{{ node }}"
        vmid: "{{ vmid }}"
        state: started
      register: results_action_start_again

    - assert:
        that:
        - results_action_start_again is not changed
        - results_action_start_again.status == 'running'
        - results_action_start_again.vmid == {{ vmid }}
        - results_action_start_again.msg == "VM {{ vmid }} is already running"

    - name: Check current status
      proxmox_kvm:
        api_host: "{{ api_host }}"
        api_user: "{{ user }}@{{ domain }}"
        api_password: "{{ api_password | default(omit) }}"
        api_token_id: "{{ api_token_id | default(omit) }}"
        api_token_secret: "{{ api_token_secret | default(omit) }}"
        validate_certs: "{{ validate_certs }}"
        node: "{{ node }}"
        vmid: "{{ vmid }}"
        state: current
      register: results_action_current

    - assert:
        that:
        - results_action_current is not changed
        - results_action_current.status == 'running'
        - results_action_current.vmid == {{ vmid }}
        - results_action_current.msg == "VM test-instance with vmid = {{ vmid }} is running"

- name: VM stop
  tags: [ 'stop' ]
  block:
    - name: Stop test VM
      proxmox_kvm:
        api_host: "{{ api_host }}"
        api_user: "{{ user }}@{{ domain }}"
        api_password: "{{ api_password | default(omit) }}"
        api_token_id: "{{ api_token_id | default(omit) }}"
        api_token_secret: "{{ api_token_secret | default(omit) }}"
        validate_certs: "{{ validate_certs }}"
        node: "{{ node }}"
        vmid: "{{ vmid }}"
        state: stopped
      register: results_action_stop

    - assert:
        that:
        - results_action_stop is changed
        - results_action_stop.status == 'running'
        - results_action_stop.vmid == {{ vmid }}
        - results_action_stop.msg == "VM {{ vmid }} is shutting down"

    - pause:
        seconds: 5

    - name: Check current status again
      proxmox_kvm:
        api_host: "{{ api_host }}"
        api_user: "{{ user }}@{{ domain }}"
        api_password: "{{ api_password | default(omit) }}"
        api_token_id: "{{ api_token_id | default(omit) }}"
        api_token_secret: "{{ api_token_secret | default(omit) }}"
        validate_certs: "{{ validate_certs }}"
        node: "{{ node }}"
        vmid: "{{ vmid }}"
        state: current
      register: results_action_current

    - assert:
        that:
        - results_action_current is not changed
        - results_action_current.status == 'stopped'
        - results_action_current.vmid == {{ vmid }}
        - results_action_current.msg == "VM test-instance with vmid = {{  vmid }} is stopped"
