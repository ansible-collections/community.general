# Copyright (c) Ansible Project
# GNU General Public License v3.0+ (see LICENSES/GPL-3.0-or-later.txt or https://www.gnu.org/licenses/gpl-3.0.txt)
# SPDX-License-Identifier: GPL-3.0-or-later

# This task block is included by package_names.yml once for each test package,
# having set package variable to the name to test
- name: Test one package
  block:
    - debug:
        var: package

    - name: Assure package is absent
      homebrew:
        package: "{{ package[0] }}"
        state: absent
        update_homebrew: false
      become: true
      become_user: "{{ brew_stat.stat.pw_name }}"

    - name: Install package by an alternative name
      homebrew:
        package: "{{ package[1] }}"
        state: present
        update_homebrew: false
      become: true
      become_user: "{{ brew_stat.stat.pw_name }}"
      register: package_result

    - assert:
        that:
          - package_result is changed
          - package_result.changed_pkgs[0] == package[1]
          - package_result.unchanged_pkgs | length == 0
          - 'package_result.msg == "Package installed: " ~ package[1]'

    - name: Reinstall should do nothing
      homebrew:
        package: "{{ package[1] }}"
        state: present
        update_homebrew: false
      become: true
      become_user: "{{ brew_stat.stat.pw_name }}"
      register: package_result

    - assert:
        that:
          - package_result is not changed
          - 'package_result.msg == "Package already installed: " ~ package[1]'

    - name: Uninstall should work on alternate name
      homebrew:
        package: "{{ package[1] }}"
        state: absent
        update_homebrew: false
      become: true
      become_user: "{{ brew_stat.stat.pw_name }}"
      register: package_result

    - assert:
        that:
          - package_result is changed
          - 'package_result.msg == "Package uninstalled: " ~ package[1]'
