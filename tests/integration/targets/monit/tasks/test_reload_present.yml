- name: reload monit when process is missing
  monit:
    name: httpd_echo
    state: reloaded
  register: result

- name: check that state is changed
  assert:
    that:
      - result is success
      - result is changed

- name: test process not present
  monit:
    name: httpd_echo
    state: present
    timeout: 5
  register: result
  failed_when: result is not skip and result is success

- name: test monitor missing process
  monit:
    name: httpd_echo
    state: monitored
  register: result
  failed_when: result is not skip and result is success

- name: start process
  shell: "{{ process_run_cmd }}"

- import_tasks: check_state.yml
  vars:
    reason: verify service running
    service_state: "up"

- name: add process config
  blockinfile:
    path: "{{ monitrc }}"
    block: |
      check process httpd_echo with matching "httpd_echo"
          start program = "{{ process_run_cmd }}"
          stop program = "/bin/sh -c 'kill `pgrep -f httpd_echo`'"
          if failed host localhost port 8082 then restart

- block:
  # in automated builds this task fails periodically because the monit daemon gets
  # stuck in the 'initializing' state. Hence the rescue section
  - name: test process present (implicit reload)
    monit:
      name: httpd_echo
      state: present
      timeout: 30
    register: result
    until: not result.failed
    retries: 2
    delay: 10
  rescue:
    - name: restart monit
      service:
        name: monit
        state: restarted
      register: restart_result

    - name: test process present (final attempt)
      monit:
        name: httpd_echo
        state: present
        timeout: 30

- name: check that state is changed
  assert:
    that:
      - result is success
      - result is changed
  # ignore this test if we had to rescue the 'test process present'
  when: restart_result is not defined

- name: test process present again
  monit:
    name: httpd_echo
    state: present
  register: result

- name: check that state is unchanged
  assert:
    that:
      - result is success
      - result is not changed
