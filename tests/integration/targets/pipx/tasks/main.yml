---
- name: install pipx
  pip:
    name: pipx
    extra_args: --user

- name: retrieve python user base directory
  command:
    argv: ["{{ ansible_python_interpreter}}", -m, site, --user-base]
  register: python_user_base
- name: pipx install destination
  ansible.builtin.set_fact:
    pipx_path: '{{ python_user_base.stdout|trim }} + "/bin/pipx"'
  when: ansible_os_family == 'Darwin'


##############################################################################
- name: install application tox
  community.general.pipx:
    name: tox
    executable: "{{ pipx_path|default(omit) }}"
  register: install_tox

- name: install application tox again
  community.general.pipx:
    name: tox
    executable: "{{ pipx_path|default(omit) }}"
  register: install_tox_again
  ignore_errors: yes

- name: install application tox again force
  community.general.pipx:
    name: tox
    force: yes
    executable: "{{ pipx_path|default(omit) }}"
  register: install_tox_again_force

- name: uninstall application tox
  community.general.pipx:
    state: absent
    name: tox
    executable: "{{ pipx_path|default(omit) }}"
  register: uninstall_tox

- name: check assertions tox
  assert:
    that:
        - install_tox is changed
        - "'tox' in install_tox.application"
        - install_tox_again is not changed
        - install_tox_again is failed
        - install_tox_again_force is changed
        - uninstall_tox is changed
        - "'tox' not in uninstall_tox.application"

##############################################################################
- name: install application tox 324
  community.general.pipx:
    name: tox
    source: tox==3.24.0
    executable: "{{ pipx_path|default(omit) }}"
  register: install_tox_324

- name: reinstall tox 324
  community.general.pipx:
    name: tox
    state: reinstall
    executable: "{{ pipx_path|default(omit) }}"
  register: reinstall_tox_324

- name: upgrade tox 324
  community.general.pipx:
    name: tox
    state: upgrade
    executable: "{{ pipx_path|default(omit) }}"
  register: upgrade_tox_324

- name: downgrade tox 324
  community.general.pipx:
    name: tox
    source: tox==3.24.0
    force: yes
    executable: "{{ pipx_path|default(omit) }}"
  register: downgrade_tox_324

- name: cleanup tox 324
  community.general.pipx:
    state: absent
    name: tox
    executable: "{{ pipx_path|default(omit) }}"
  register: uninstall_tox_324

- name: check assertions tox 324
  assert:
    that:
        - install_tox_324 is changed
        - "'tox' in install_tox_324.application"
        - install_tox_324.application.tox.version == '3.24.0'
        - reinstall_tox_324 is changed
        - reinstall_tox_324.application.tox.version == '3.24.0'
        - upgrade_tox_324 is changed
        - upgrade_tox_324.application.tox.version != '3.24.0'
        - downgrade_tox_324 is changed
        - downgrade_tox_324.application.tox.version == '3.24.0'
        - uninstall_tox_324 is changed
        - "'tox' not in uninstall_tox_324.application"
