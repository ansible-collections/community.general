####################################################################
# WARNING: These are designed specifically for Ansible tests       #
# and should not be used as examples of how to write Ansible roles #
####################################################################

# Test code for the disk_info module
# Copyright 2021 VMware, Inc
#
# GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)
- name: "Installing the psutil module"
  pip:
    name: psutil < 5.7.0
    # Version 5.7.0 breaks on python 2.x. See https://github.com/ansible/ansible/pull/70667
  when: ansible_python_version is version ('3', '<')

- name: "Installing the psutil module for python version 3"
  pip:
    name: psutil
  when: ansible_python_version is version ('3', '>=')

- name: "Checking the information from df command"
  shell:  "df -h | grep '^/dev/' | awk '{ print $1 }'"
  register: result_df

- name: "Checking the all disk info"
  community.general.disk_info:
  register: result_all_disk

- name: "Checking the specific disk info"
  community.general.disk_info:
    name: "{{ result_df.stdout_lines[0] }}"
  register: result_specific_disk

- name: "Obtaining all disk info check"
  assert:
    that:
      - "{{ result_df.stdout_lines | unique | length }} == {{ result_all_disk['ansible_facts'].keys() | length }}"
    success_msg: "Check for obtaining all disk info passed"
    fail_msg: "Check for obtaining all disk info failed"

- name: "Obtaining specific disk info check"
  assert:
    that:
      - result_specific_disk['ansible_facts'] != {}
    success_msg: "Check for obtaining specific disk info passed"
    fail_msg: "Check for obtaining specific disk info failed"
