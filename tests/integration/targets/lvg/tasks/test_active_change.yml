---
# Copyright (c) Ansible Project
# GNU General Public License v3.0+ (see LICENSES/GPL-3.0-or-later.txt or https://www.gnu.org/licenses/gpl-3.0.txt)
# SPDX-License-Identifier: GPL-3.0-or-later

- name: Create volume group on disk device
  lvg:
    vg: testvg
    pvs: "{{ loop_device1 }}"

- name: Create logical volumes on volume group
  loop:
    - lv1
    - lv2
  lvol:
    vg: testvg
    lv: "{{ item }}"
    size: 2m

- name: Collect all lv active status in testvg
  shell: vgs -olv_active --noheadings testvg | xargs -n1
  register: cmd_result

- name: Assert all lv in testvg are active
  loop: "{{ cmd_result.stdout_lines }}"
  assert:
    that:
      - "'active' == '{{ item }}'"

- name: Deactivate volume group
  lvg:
    vg: testvg
    active: false
  register: vg_deactivate

- name: Collect all lv active status in testvg
  shell: vgs -olv_active --noheadings testvg | xargs -n1
  register: cmd_result

- name: Do all assertions to verify expected results
  assert:
    that:
      - vg_deactivate is changed
      - "'active' not in cmd_result.stdout"

- name: Deactivate volume group again to verify idempotence
  lvg:
    vg: testvg
    active: false
  register: repeat_vg_deactivate

- name: Verify vg deactivation idempontency
  assert:
    that:
      - repeat_vg_deactivate is not changed

- name: Activate volume group 
  lvg:
    vg: testvg
    active: true
  register: vg_activate

- name: Collect all lv active status in testvg
  shell: vgs -olv_active --noheadings testvg | xargs -n1
  register: cmd_result

- name: Verify vg activation
  assert:
    that:
      - vg_activate is changed

- name: Assert all lv in testvg are active
  loop: "{{ cmd_result.stdout_lines }}"
  assert:
    that:
      - "'active' == '{{ item }}'"

- name: Activate volume group again to verify idempontency
  lvg:
    vg: testvg
    active: true
  register: repeat_vg_activate

- name: Verify vg activation idempontency
  assert:
    that:
      - repeat_vg_activate is not changed

- name: Deactivate lv2 in testvg
  lvol:
    vg: testvg
    lv: lv2
    active: false

- name: Activate volume group again to verify partially activated vg activation
  lvg:
    vg: testvg
    active: true
  register: partial_vg_activate

- name: Verify partially activated vg activation
  assert:
    that:
      - partial_vg_activate is changed

- name: Collect all lv active status in testvg
  shell: vgs -olv_active --noheadings testvg | xargs -n1
  register: cmd_result

- name: Assert all lv in testvg are active
  loop: "{{ cmd_result.stdout_lines }}"
  assert:
    that:
      - "'active' == '{{ item }}'"