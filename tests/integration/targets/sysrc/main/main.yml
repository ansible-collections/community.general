---
- name: Test on FreeBSD VMs
  when:
    - ansible_facts.virtualization_type != 'docker'
    - ansible_facts.distribution == 'FreeBSD'
  block:
    - name: Cache original contents of /etc/rc.conf
      shell: "cat /etc/rc.conf"
      register: sysrc_original_content

    ##
    ## sysrc - /etc/rc.conf manipulation
    ##
    - name: Add to /etc/rc.conf
      sysrc:
        name: sysrc_test
        value: test
      register: sysrc_test0

    - name: Get file content
      shell: "cat /etc/rc.conf | egrep -v ^\\#"
      register: sysrc_content0

    - name: Add to /etc/rc.conf
      sysrc:
        name: sysrc_test
        value: test
      register: sysrc_test0_change

    - name: Validate results
      assert:
        that:
          - "sysrc_test0 is changed"
          - "sysrc_test0_change is not changed"
          - "'sysrc_test=\"test\"' in sysrc_content0.stdout_lines"

    - name: Remove from /etc/rc.conf
      sysrc:
        name: sysrc_test
        state: absent
      register: sysrc_test1

    - name: Get file content
      shell: "cat /etc/rc.conf | egrep -v ^\\#"
      register: sysrc_content1

    - name: Remove from /etc/rc.conf
      sysrc:
        name: sysrc_test
        state: absent
      register: sysrc_test1_change

    - name: Validate results for key removal
      assert:
        that:
          - sysrc_test1 is changed
          - sysrc_test1_change is not changed
          - '"sysrc_test1" not in sysrc_content1.stdout_lines'

    ##
    ## sysrc - append/subtract
    ##
    - name: Reset /etc/rc.conf
      copy:
        content: sysrc_original_content.stdout
        path: /etc/rc.conf

    - name: Append value (creates)
      sysrc:
        name: sysrc_test_append
        state: value_present
        value: test_a
      register: sysrc_test2_create

    - name: Append value (append)
      sysrc:
        name: sysrc_test_append
        state: value_present
        value: test_b
      register: sysrc_test2

    - name: Get file content
      shell: "cat /etc/rc.conf | egrep -v ^\\#"
      register: sysrc_content2

    - name: Append same value
      sysrc:
        name: sysrc_test_append
        state: value_present
        value: test_b
      register: sysrc_test2_change

    - name: Validate results for key appending
      assert:
        that:
          - sysrc_test2_create is changed
          - sysrc_test2 is changed
          - sysrc_test2_change is not changed
          - '"sysrc_test_append=\"test_a test_b\"" in sysrc_content2.stdout_lines'

    - name: Subtract value
      sysrc:
        name: sysrc_test_append
        state: value_absent
        value: test_b
      register: sysrc_test3

    - name: Get file content
      shell: "cat /etc/rc.conf | egrep -v ^\\#"
      register: sysrc_content3

    - name: Subtract value
      sysrc:
        name: sysrc_test_append
        state: value_absent
        value: test_b
      register: sysrc_test3_change

    - name: Validate results for key subtraction
      assert:
        that:
          - sysrc_test3 is changed
          - sysrc_test3_change is not changed
          - '"sysrc_test_append=\"test_a\"" in sysrc_content3.stdout_lines'

    ##
    ## sysrc - append/subtract with delimiter
    ##
    - name: Append value (delimiter)
      sysrc:
        name: sysrc_test_append
        state: value_present
        delim: ','
        value: test_b
      register: sysrc_test4

    - name: Get file content
      shell: "cat /etc/rc.conf | egrep -v ^\\#"
      register: sysrc_content4

    - name: Append value again (delimiter)
      sysrc:
        name: sysrc_test_append
        state: value_present
        delim: ','
        value: test_b
      register: sysrc_test4_change

    - name: Validate results for key appending
      assert:
        that:
          - sysrc_test4 is changed
          - sysrc_test4_change is not changed
          - '"sysrc_test_append=\"test_a,test_b\"" in sysrc_content4.stdout_lines'

    - name: Subtract value (delimiter)
      sysrc:
        name: sysrc_test_append
        state: value_absent
        delim: ','
        value: test_b
      register: sysrc_test5

    - name: Get file content
      shell: "cat /etc/rc.conf | egrep -v ^\\#"
      register: sysrc_content5

    - name: Subtract value again (delimiter)
      sysrc:
        name: sysrc_test_append
        state: value_absent
        delim: ','
        value: test_b
      register: sysrc_test5_change

    - name: Validate results for key appending
      assert:
        that:
          - sysrc_test5 is changed
          - sysrc_test5_change is not changed
          - '"sysrc_test_append=\"test_a\"" in sysrc_content5.stdout_lines'

    ##
    ## sysrc - uses alternate file
    ##
    - name: Use alternate file
      sysrc:
        name: sysrc_test
        value: test
        path: /tmp/sysrc_file
      register: sysrc_test6

    - name: Assert file exists
      stat:
        path: /tmp/sysrc_file
      register: sysrc_file

    - name: Use alternate file (idempotent)
      sysrc:
        name: sysrc_test
        value: test
        path: /tmp/sysrc_file
      register: sysrc_test6_idempotent

    - name: Validate file
      assert:
        that:
          - sysrc_file.stat.exists
          - sysrc_test6 is changed
          - sysrc_test6_idempotent is not changed

    # OID-like variables should fail
    - name: OID style names should fail
      register: sysrc_no_oid
      failed_when: '"Name may only contain alpha-numeric and underscore characters" not in sysrc_no_oid.msg'
      sysrc:
        name: a.b
        value: test

    ##
    ## sysrc - jail
    ##
    - name: Creates file in jail
      register: jail_test0
      sysrc:
        name: test_jail
        value: test
        jail: testjail

    - name: Jail file exists
      register: jail_file0
      stat:
        path: /usr/jails/testjail/etc/rc.conf

    - name: Validate jail file is changed
      assert:
        that:
          - jail_test0 is changed
          - jail_file0.stat.exists
