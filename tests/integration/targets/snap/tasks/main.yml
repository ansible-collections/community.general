---
####################################################################
# WARNING: These are designed specifically for Ansible tests       #
# and should not be used as examples of how to write Ansible roles #
####################################################################

- name: install snapd on ubuntu
  apt:
    name: snapd
    state: present
  register: snapd_install_ubuntu
  when: ansible_distribution == 'Ubuntu'

- name: install snapd on fedora
  dnf:
    name: snapd
    state: present
  register: snapd_install_fedora
  when: ansible_distribution == 'Fedora'

- block:
    - name: add opensuse repository
      community.general.zypper_repository:
        name: snapd
        repo: 'https://download.opensuse.org/repositories/system:/snappy/openSUSE_Leap_$releasever'
        state: present
        auto_import_keys: true
      register: snapd_install_opensuse

    - name: install snapd on opensuse
      community.general.zypper:
        name: snapd
        state: present
  when: ansible_distribution == 'openSUSE Leap'

- block:
    - name: install package
      community.general.snap:
        name: hello-world
        state: present
      register: install

    - name: install package again
      community.general.snap:
        name: hello-world
        state: present
      register: install_again

    - name: Assert package has been installed just once
      assert:
        that:
          - install is changed
          - install_again is not changed

    - name: check package has been installed correctly
      command: hello-world

    - name: remove package
      community.general.snap:
        name: hello-world
        state: absent
      register: remove

    - name: remove package again
      community.general.snap:
        name: hello-world
        state: absent
      register: remove_again

    - name: Assert package has been removed just once
      assert:
        that:
          - remove is changed
          - remove_again is not changed
  when: ansible_distribution in ['Ubuntu','Fedora', 'openSUSE Leap']

- name: Remove snapd in case it was not installed
  apt:
    name: snapd
    state: absent
  when: snapd_install_ubuntu is changed and ansible_distribution == 'Ubuntu'

- name: Remove snapd in case it was not installed
  dnf:
    name: snapd
    state: absent
  when: snapd_install_fedora is changed and ansible_distribution == 'Fedora'

- block:
    - name: remove opensuse repository
      community.general.zypper_repository:
        name: snapd
        state: absent

    - name: remove snapd on opensuse
      community.general.zypper:
        name: snapd
        state: present
  when: snapd_install_opensue is changed and ansible_distribution == 'openSUSE Leap'
