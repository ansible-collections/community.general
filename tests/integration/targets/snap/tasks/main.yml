---
####################################################################
# WARNING: These are designed specifically for Ansible tests       #
# and should not be used as examples of how to write Ansible roles #
####################################################################

- name: install snapd on ubuntu
  apt:
    name: snapd
    state: present
  notify: remove snapd in ubuntu
  when: ansible_distribution == 'Ubuntu'

- name: install snapd on fedora
  dnf:
    name: snapd
    state: present
  notify: remove snapd in fedora
  when: ansible_distribution == 'Fedora'

- block:
    - name: add opensuse repository
      community.general.zypper_repository:
        name: snapd
        repo: 'https://download.opensuse.org/repositories/system:/snappy/openSUSE_Leap_$releasever'
        state: present
        auto_import_keys: true
      notify: remove opensuse repository

    - name: install snapd on opensuse
      community.general.zypper:
        name: snapd
        state: present
      notify: remove snapd in opensuse
  when: ansible_distribution == 'openSUSE Leap'

- block:
    - name: install package
      community.general.snap:
        name: hello-world
        state: present
      register: install

    - name: install package again
      community.general.snap:
        name: hello-world
        state: present
      register: install_again

    - name: Assert package has been installed just once
      assert:
        that:
          - install is changed
          - install_again is not changed

    - name: check package has been installed correctly
      command: hello-world

    - name: remove package
      community.general.snap:
        name: hello-world
        state: absent
      register: remove

    - name: remove package again
      community.general.snap:
        name: hello-world
        state: absent
      register: remove_again

    - name: Assert package has been removed just once
      assert:
        that:
          - remove is changed
          - remove_again is not changed
  when: ansible_distribution in ['Ubuntu','Fedora', 'openSUSE Leap']

